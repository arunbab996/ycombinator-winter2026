<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />

<title>DiscoveryOS</title>

<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Crect width='64' height='64' fill='%23FF8A00'/%3E%3C/svg%3E">

<style>
/* -- styling identical as before, truncated for space -- */
</style>
</head>

<body>
<div class="app">
  <div class="header">
    <div class="logo">
      <img src="icons8-ghost.gif" alt="logo">
    </div>
    <div class="title-wrapper">
      <h1>DiscoveryOS</h1>
      <div class="subtitle">Your radar for breakout startups ðŸš€</div>
    </div>
  </div>

  <div class="controls">
    <input id="search" class="search" type="text"
      placeholder="Search company, tagline, or source (YC / PH)" />
  </div>

  <div id="content"></div>
</div>

<script>
/* === CONFIG === */
const SHEET_ID = '1OaIx6CeopLNuiYQrDUurO_6B-cCHh3g2QMWtC7UDz5U';
const GID = '1778821196';
const CSV_URL =
  `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`;

/* === CSV PARSE HELPERS === */
function splitCsvLine(line){
  const out=[]; let cur='', q=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch==='\"'){
      if(q && line[i+1]==='\"'){cur+='"';i++;continue;}
      q=!q;continue;
    }
    if(ch===',' && !q){out.push(cur);cur='';continue;}
    cur+=ch;
  }
  out.push(cur);
  return out.map(s=>s.trim().replace(/^"|"$/g,''));
}
function csvToObjects(csv){
  const lines = csv.split(/\r?\n/).filter(x=>x.trim());
  if(!lines.length) return [];
  const header = splitCsvLine(lines[0]);
  return lines.slice(1).map(l=>{
    const cols = splitCsvLine(l);
    const o={};
    header.forEach((h,i)=>o[h]=cols[i]||'');
    return o;
  });
}

function pick(r, list){
  for(const k of list){
    if(r[k] && r[k].trim()) return r[k].trim();
  }
  return "";
}

function getDomain(url){
  try{
    if(!url) return null;
    const u = url.startsWith('http') ? url : `https://${url}`;
    return new URL(u).hostname;
  }catch(e){ return null; }
}

function favicon(url){
  const domain = getDomain(url);
  return domain ? `https://www.google.com/s2/favicons?sz=128&domain=${domain}` : null;
}

/* âœ” ONLY USE Logo URL IF source == "PH" */
function companyLogo(row){
  const src = pick(row, ['source','Source']);
  const logoUrl = pick(row, ['Logo URL','LogoURL','Logo_Url']);
  const website = pick(row, ['Website']);

  if (src.toLowerCase() === "ph" && logoUrl) {
    return logoUrl;
  }
  return favicon(website);
}

function parseDate(r){
  const d = pick(r,['Extracted Date','ExtractedDate','Date']);
  const dt=new Date(d);
  return isNaN(dt)? d : dt.toISOString().slice(0,10);
}

function formatDate(d){
  const dt=new Date(d);
  return isNaN(dt)? d : dt.toLocaleDateString(undefined,{year:'numeric',month:'long',day:'numeric'});
}

function groupByDate(rows){
  const g={};
  rows.forEach(r=>{
    const key=parseDate(r)||'Unknown';
    if(!g[key]) g[key]=[];
    g[key].push(r);
  });
  return g;
}

function esc(s){
  return String(s||'')
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;');
}

/* icons */
const siteI = `
<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none">
  <circle cx="12" cy="12" r="10" stroke="currentColor"/>
  <path d="M2 12h20M12 2c2.5 2.8 4 6.5 4 10s-1.5 7.2-4 10M12 2C9.5 4.8 8 8.5 8 12s1.5 7.2 4 10" stroke="currentColor"/>
</svg>`;

const ycI = `
<svg width="20" height="20" viewBox="0 0 24 24">
  <rect width="24" height="24" rx="6" fill="#FF8A00"/>
  <path d="M8 12h8" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
</svg>`;

/* === RENDER === */
function render(groups, txt){
  const q=(txt||'').toLowerCase();
  const keys=Object.keys(groups).sort((a,b)=>b.localeCompare(a));
  const c=document.getElementById('content');
  let html='';

  keys.forEach(date=>{
    const items = groups[date].filter(r=>{
      const name = pick(r,['Correct Name','CorrectName','Name']);
      const tagline = pick(r,['Correct Tagline','CorrectTagline','Tagline']);
      const src = pick(r,['source','Source']);
      return !q || `${name} ${tagline} ${src}`.toLowerCase().includes(q);
    });

    if(!items.length) return;

    html += `<div class="date-group"><div class="date-header">${esc(formatDate(date))}</div>`;

    items.forEach(r=>{
      const name = pick(r,['Correct Name','CorrectName','Name']);
      if(!name || name==='#VALUE!') return;

      const tagline = pick(r,['Correct Tagline','CorrectTagline','Tagline']);
      const src     = pick(r,['source','Source']);
      const site    = pick(r,['Website']);
      const yc      = pick(r,['YC URL','YC']);
      const logo    = companyLogo(r);   // <--- controlled behavior

      html += `
      <div class="card">
        <div class="left">
          ${logo
            ? `<img src="${esc(logo)}" alt="${esc(name)}"
                    onerror="this.style.display='none'">`
            : `<div>${esc(name[0])}</div>`}
        </div>

        <div class="center">
          <div class="title-row">
            <div style="min-width:0">
              <div class="name">${esc(name)}</div>
              ${tagline?`<div class="tagline">${esc(tagline)}</div>`:''}
              <div class="meta">
                ${src ? `<span class="tag">${esc(src)}</span>` : ''}
              </div>
            </div>

            <div class="actions">
              ${site
                ? `<a class="btn btn--site" target="_blank" href="${esc(site.startsWith('http')?site:'https://'+site)}">${siteI}</a>`
                : ''}

              ${yc
                ? `<a class="btn btn--yc" target="_blank" href="${esc(yc.startsWith('http')?yc:'https://'+yc)}">${ycI}</a>`
                : ''}
            </div>
          </div>
        </div>
      </div>`;
    });

    html += `</div>`;
  });

  c.innerHTML = html || `<div class="empty">No companies match your search</div>`;
}

/* === LOAD === */
async function load(){
  document.getElementById('content').innerHTML=`<div class="empty">Loading...</div>`;
  try{
    const resp=await fetch(CSV_URL);
    const txt=await resp.text();
    const rows=csvToObjects(txt);

    const filtered = rows.filter(r=>{
      const name = pick(r,['Correct Name','CorrectName','Name']);
      return name && name !== '#VALUE!';
    });

    const groups = groupByDate(filtered);
    window.__DB = groups;
    render(groups, document.getElementById('search').value);
  }catch(e){
    document.getElementById('content').innerHTML=`<div class="empty">${esc(e.message)}</div>`;
  }
}

document.getElementById('search').addEventListener('input',()=>{
  render(window.__DB||{}, document.getElementById('search').value);
});

load();
</script>
</body>
</html>
