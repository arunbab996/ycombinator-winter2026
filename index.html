<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='0' fill='%23ffffff'/><path d='M35 80 L65 20' stroke='%23000000' stroke-width='8' stroke-linecap='square'/></svg>">
<title>discovery/os</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<style>
:root{
  /* MATTE BLACK PALETTE */
  --bg:#000000;
  --bg-sidebar:#050505;
  --bg-card:#0A0A0A;
  --bg-modal:#111111;
  --border:#1A1A1A;
  --border-soft:#121212;
  --border-visible:#333333;

  --text:#F4F4F5;
  --text-soft:#A1A1AA;
  --text-softer:#52525B;

  --accent:#F97316;
  --accent-saved:#EAB308;
  --yc-pill-border:rgba(249,115,22,0.5);

  --font-sans: 'Inter', system-ui, -apple-system, sans-serif;
  --font-mono: 'JetBrains Mono', monospace;

  font-family: var(--font-sans);
}

*{box-sizing:border-box;}

html,body{
  margin:0; padding:0; height:100%;
  background-color:var(--bg); color:var(--text);
  -webkit-font-smoothing:antialiased;
}

body{
  display:flex;
  overflow: hidden; /* Prevent body scroll on desktop */
}

/* --- SIDEBAR --- */
.sidebar {
  width: 250px;
  height: 100vh;
  background: var(--bg-sidebar);
  border-right: 1px solid var(--border);
  display: flex; flex-direction: column;
  flex-shrink: 0;
}

.sidebar-header {
  padding: 20px 24px;
  display: flex; align-items: center; gap: 10px;
  border-bottom: 1px solid var(--border-soft);
}

.brand-mark {
  width: 28px; height: 28px; background: #F4F4F5; border-radius: 4px;
  display:flex; align-items:center; justify-content:center;
}
.brand-mark svg { width: 16px; height: 16px; }

.brand-text { display:flex; flex-direction:column; gap:2px; }
.brand-name {
  font-family: var(--font-mono); 
  font-size: 14px; 
  letter-spacing: -0.03em; 
  font-weight: 600; 
  color: #F4F4F5; 
  line-height: 1;
}
.brand-sub { font-family: var(--font-mono); font-size: 10px; color: var(--text-softer); }

.sidebar-nav {
  padding: 24px 16px; flex: 1; overflow-y: auto;
  display: flex; flex-direction: column; gap: 24px;
}

.nav-section-label {
  padding: 0 12px; margin-bottom: 8px;
  font-family: var(--font-mono); font-size: 10px; text-transform: uppercase;
  color: var(--text-softer); letter-spacing: 0.05em;
}

.nav-item {
  display: flex; align-items: center; gap: 10px;
  padding: 8px 12px; border-radius: 6px;
  color: var(--text-soft); text-decoration: none;
  font-size: 13px; font-weight: 500; cursor: pointer;
  transition: all 0.2s;
  font-family: var(--font-sans);
}
.nav-item:hover { background: #111; color: var(--text); }
.nav-item.active { background: #1A1A1A; color: #fff; }
.nav-icon { 
  width: 16px; height: 16px; 
  display: flex; align-items: center; justify-content: center;
  color: var(--text-softer);
}
.nav-icon svg { width: 100%; height: 100%; }
.nav-item.active .nav-icon { color: #fff; }

.sidebar-footer {
  padding: 16px 20px; border-top: 1px solid var(--border);
  font-size: 11px; color: var(--text-softer);
  display: flex; flex-direction: column; gap: 8px;
}

.status-row { display: flex; align-items: center; gap: 8px; font-family: var(--font-mono); font-size: 10px; }
.status-dot { width: 6px; height: 6px; border-radius: 99px; background: #22C55E; box-shadow: 0 0 6px rgba(34,197,94,0.4); }
.status-dot.cached { background: #3B82F6; box-shadow: 0 0 6px rgba(59,130,246,0.4); }

.footer-link { color: inherit; text-decoration: none; cursor: pointer; transition: color 0.2s; }
.footer-link:hover { color: var(--text); }

/* --- MAIN CONTENT --- */
.main {
  flex: 1; display: flex; flex-direction: column;
  height: 100vh; overflow: hidden; position: relative;
}

/* COMMAND HEADER */
.command-bar {
  height: 64px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 24px; background: rgba(0,0,0,0.8);
  backdrop-filter: blur(12px); z-index: 10;
}

.search-container {
  position: relative; width: 320px;
}
.search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--text-softer); font-size: 14px; }
.search-input {
  width: 100%; background: #0A0A0A; border: 1px solid var(--border);
  padding: 8px 12px 8px 32px; border-radius: 6px;
  color: var(--text); font-family: var(--font-sans); font-size: 13px;
  transition: border-color 0.2s;
}
.search-input:focus { outline: none; border-color: #333; }

.view-toggles { display: flex; background: #0A0A0A; padding: 2px; border-radius: 6px; border: 1px solid var(--border); }
.view-btn {
  background: transparent; border: none; color: var(--text-soft);
  padding: 6px 12px; font-size: 11px; font-weight: 500; cursor: pointer; border-radius: 4px;
}
.view-btn.active { background: #1A1A1A; color: #fff; }


/* SCROLLABLE FEED */
.content-area {
  flex: 1; overflow-y: auto; padding: 0 24px 40px;
  max-width: 1200px; width: 100%; margin: 0 auto;
  position: relative;
}

.feed-header {
  margin-top: 32px; margin-bottom: 16px;
  display: flex; justify-content: space-between; align-items: flex-end;
  border-bottom: 1px solid var(--border-soft); padding-bottom: 8px;
}
.feed-title { font-size: 18px; font-weight: 600; color: #fff; }
.feed-meta { font-family: var(--font-mono); font-size: 11px; color: var(--text-softer); }

/* --- DOM PERSISTENCE LAYERS --- */
#view-feed { display: block; }
#view-scanner { display: none; }

/* When Scanner is Active */
.mode-scanner #view-feed { display: none; }
.mode-scanner #view-scanner { display: block; }


/* CARDS & TABLES */
@keyframes fadeIn {from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); }}
.date-group{margin-top:24px; animation: fadeIn 0.4s ease-out forwards;}
.date-header{
  font-family: var(--font-mono); font-size:10px; font-weight: 500;
  text-transform:uppercase; letter-spacing:0.05em; color:var(--text-softer);
  margin-bottom:12px; padding-left: 2px;
}

.card{
  display:flex; align-items:flex-start; gap:16px; padding:16px;
  border-radius:12px;
  background: rgba(10, 10, 10, 0.6);
  border: 1px solid var(--border-soft);
  transition: all 0.2s ease; cursor: pointer;
}
.card:hover{
  background: #0F0F0F; transform: translateY(-1px);
  border-color: #333; box-shadow: 0 4px 12px rgba(0,0,0,0.4);
}
.card + .card{margin-top:10px;}

.card-left{
  width:48px; height:48px; border-radius:8px; background:#111;
  border:1px solid var(--border); display:flex; align-items:center;
  justify-content:center; flex-shrink:0; overflow:hidden;
}
.card-left img{width:100%; height:100%; object-fit:contain; padding: 6px;}
.card-left-fallback{font-family: var(--font-mono); font-size:16px; color:var(--text-soft);}
.card-center{flex:1; min-width: 0;}
.card-top-row{display:flex; align-items:flex-start; justify-content: space-between; gap:12px;}
.card-main{flex:1; min-width:0; display: flex; flex-direction: column; gap: 4px;}
.card-name{font-size:15px; font-weight:600; color: #fff; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
.card-tagline{font-size:13px; color:var(--text-soft); line-height:1.4; font-weight: 400;}
.card-right{display:flex; flex-direction:column; gap:8px; align-items:flex-end;}

.yc-pill{
  font-family: var(--font-mono); padding:4px 10px; border-radius:6px;
  font-size:11px; font-weight: 600; letter-spacing: 0.05em;
  background: transparent; border: 1px solid var(--yc-pill-border);
  color: #FB923C; box-shadow: 0 0 8px rgba(249, 115, 22, 0.15);
}

.card-link-row{display:flex; align-items:center; gap:8px;}
.btn-link{
  display:inline-flex; align-items:center; justify-content:center;
  width:32px; height:32px; border-radius:6px;
  border:1px solid var(--border-visible); background:#0F0F0F;
  color:var(--text-soft); text-decoration:none;
  transition: all 0.2s; cursor: pointer;
}
.btn-link:hover{background: #222; color: var(--text); border-color: #555;}
.btn-link--active{color: var(--accent-saved); border-color: rgba(234, 179, 8, 0.4); background: rgba(234, 179, 8, 0.1);}
.btn-link--active:hover{background: rgba(234, 179, 8, 0.15); border-color: rgba(234, 179, 8, 0.6);}

/* MASONRY TWEET GRID */
.scanner-grid {
  column-count: 3; /* 3 Columns for wide screens */
  column-gap: 24px;
  width: 100%;
}
.tweet-card {
  break-inside: avoid;
  margin-bottom: 24px;
  background: transparent;
  width: 100%;
  display: inline-block;
  min-height: 150px;
  position: relative;
}
/* Tweet Loading Skeleton */
.tweet-skeleton {
  position: absolute; top:0; left:0; width:100%; height:200px;
  background: #0A0A0A; border: 1px solid var(--border); border-radius: 12px;
  display: flex; flex-direction: column; padding: 16px; gap: 12px;
  z-index: 1;
}
.twitter-tweet { margin: 0 !important; width: 100% !important; position: relative; z-index: 2; }

/* Responsive Columns */
@media (max-width: 1100px) { .scanner-grid { column-count: 2; } }
@media (max-width: 700px) { .scanner-grid { column-count: 1; } }


/* TABLE VIEW */
.table-view{width:100%; border-collapse:collapse; font-size:13px; animation: fadeIn 0.3s ease-out;}
.table-view th{
  text-align:left; font-weight:500; color:var(--text-softer);
  font-family: var(--font-mono); font-size:10px; text-transform:uppercase;
  letter-spacing:0.05em; padding: 12px 0; border-bottom: 1px solid var(--border);
}
.table-view td{padding: 12px 0; border-bottom:1px solid var(--border-soft); color: var(--text-soft);}
.table-company{font-weight:500; color: var(--text);}

/* SLIDE-OVER PANEL (Right) */
.overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.6);
  backdrop-filter: blur(4px); z-index: 150;
  opacity: 0; pointer-events: none; transition: opacity 0.3s;
}
.overlay.open { opacity: 1; pointer-events: auto; }
.panel {
  position: fixed; top: 12px; right: 12px; bottom: 12px;
  width: 480px; max-width: 90vw;
  background: #080808; border: 1px solid var(--border); border-radius: 12px;
  z-index: 200; transform: translateX(110%);
  transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  display: flex; flex-direction: column;
  box-shadow: -10px 0 40px rgba(0,0,0,0.8);
}
.panel.open { transform: translateX(0); }
.panel-header {
  padding: 16px 20px; border-bottom: 1px solid var(--border-soft);
  display: flex; justify-content: space-between; align-items: center;
}
.panel-close { background: transparent; border: none; color: var(--text-soft); font-size: 20px; cursor: pointer; }
.panel-content { padding: 24px; flex: 1; overflow-y: auto; }
.panel-hero { display: flex; gap: 16px; align-items: flex-start; margin-bottom: 24px; }
.panel-logo { width: 64px; height: 64px; border-radius: 12px; background: #111; border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; }
.panel-logo img { width: 40px; height: 40px; object-fit: contain; }
.panel-title h2 { margin: 0 0 4px 0; font-size: 20px; font-weight: 600; color: #fff; }
.panel-domain { font-family: var(--font-mono); font-size: 12px; color: var(--text-soft); }
.panel-tagline { font-size: 15px; line-height: 1.5; color: var(--text-soft); margin-bottom: 32px; border-left: 2px solid var(--border); padding-left: 16px; }
.panel-section { margin-bottom: 24px; }
.panel-label { font-family: var(--font-mono); font-size: 11px; text-transform: uppercase; color: var(--text-softer); margin-bottom: 8px; display: block; }
.panel-actions { display: flex; gap: 12px; }
.action-btn {
  flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px;
  padding: 10px; border-radius: 8px; border: 1px solid var(--border-visible);
  background: #111; color: var(--text); font-size: 13px; font-weight: 500;
  cursor: pointer; text-decoration: none; transition: all 0.2s;
}
.action-btn:hover { background: #222; border-color: #555; }
.action-btn.primary { background: var(--text); color: #000; border-color: var(--text); }
.panel-notes {
  width: 100%; height: 120px; background: #0F0F0F; border: 1px solid var(--border);
  border-radius: 8px; padding: 12px; color: var(--text); font-family: var(--font-sans);
  font-size: 13px; resize: none; transition: border-color 0.2s;
}
.panel-notes:focus { outline: none; border-color: #444; }

/* INFO MODAL */
.modal {
  position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.95);
  width: 500px; max-width: 90vw; max-height: 80vh;
  background: var(--bg-modal); border: 1px solid var(--border); border-radius: 12px;
  z-index: 250; opacity: 0; pointer-events: none; transition: all 0.2s; display: flex; flex-direction: column;
  box-shadow: 0 20px 50px rgba(0,0,0,0.8);
}
.modal.open { transform: translate(-50%, -50%) scale(1); opacity: 1; pointer-events: auto; }
.modal-header {
  padding: 16px 20px; border-bottom: 1px solid var(--border-soft);
  display: flex; justify-content: space-between; align-items: center;
}
.modal-title { font-size: 16px; font-weight: 600; color: #fff; }
.modal-content { padding: 24px; overflow-y: auto; color: var(--text-soft); font-size: 14px; line-height: 1.6; }
.modal-content h3 { color: #fff; font-size: 14px; margin: 20px 0 8px 0; }
.modal-content ul { padding-left: 20px; margin: 0; }
.modal-content li { margin-bottom: 4px; }

/* TOAST */
.toast {
  position: fixed; bottom: 32px; left: 50%; transform: translateX(-50%) translateY(100px);
  background: #fff; color: #000; padding: 12px 24px; border-radius: 999px;
  font-size: 13px; font-weight: 600; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  opacity: 0; transition: all 0.4s; z-index: 300;
  display: flex; align-items: center; gap: 8px;
}
.toast.visible { transform: translateX(-50%) translateY(0); opacity: 1; }

/* UTILS */
.empty{padding:60px 20px; font-size:13px; color:var(--text-softer); text-align:center; font-family: var(--font-mono);}
@keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
.skeleton-text {height: 12px; background: linear-gradient(90deg, #121212 25%, #1A1A1A 50%, #121212 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 4px;}
.skeleton-card {display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 12px; background: var(--bg-card); border: 1px solid var(--border-soft); margin-top: 8px;}
.skeleton-img {width: 42px; height: 42px; border-radius: 8px; background: linear-gradient(90deg, #121212 25%, #1A1A1A 50%, #121212 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; flex-shrink: 0;}
.skeleton-lines {flex: 1; display: flex; flex-direction: column; gap: 8px;}

/* SCROLLBAR */
.content-area::-webkit-scrollbar { width: 6px; }
.content-area::-webkit-scrollbar-track { background: transparent; }
.content-area::-webkit-scrollbar-thumb { background-color: #222; border-radius: 20px; border: 2px solid #000; }
.content-area:hover::-webkit-scrollbar-thumb { background-color: #333; }

/* MOBILE RESPONSIVE FIX (Enable Scrolling) */
@media (max-width: 768px) {
  body { 
    flex-direction: column; 
    overflow: auto; /* Allow scrolling on body */
    height: auto;
  }
  .sidebar { width: 100%; height: auto; border-right: none; border-bottom: 1px solid var(--border); flex-shrink: 0; }
  .sidebar-nav, .sidebar-footer, .nav-section-label { display: none; }
  .sidebar-header { padding: 12px 16px; justify-content: space-between; }
  
  .main { height: auto; overflow: visible; flex: 1; }
  .command-bar { position: sticky; top: 0; padding: 0 16px; height: 56px; }
  .search-container { width: 200px; }
  .content-area { padding: 0 16px 40px; overflow: visible; }
  .panel { width: 100%; top: 50px; bottom: 0; right: 0; max-width: 100%; border-radius: 0; transform: translateY(100%); }
  .panel.open { transform: translateY(0); }
}
</style>
</head>

<body>

<nav class="sidebar">
  <div class="sidebar-header">
    <div class="brand-mark"><svg viewBox="0 0 32 32" fill="none"><path d="M12 22L20 10" stroke="#000" stroke-width="2.5" stroke-linecap="round"/></svg></div>
    <div class="brand-text">
      <div class="brand-name">discovery/os</div>
      <div class="brand-sub">~/market-feed</div>
    </div>
  </div>
  <div class="sidebar-nav">
    <div>
      <div class="nav-section-label">Views</div>
      
      <div class="nav-item active" onclick="setFilter('today', this)">
        <span class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></span><span>Today</span>
      </div>

      <div class="nav-item" onclick="setFilter('all', this)">
        <span class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/><path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/></svg></span><span>All Data</span>
      </div>

      <div class="nav-item" onclick="setFilter('saved', this)">
        <span class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg></span><span>Starred</span>
      </div>
    </div>
    <div>
      <div class="nav-section-label">Sources</div>
      
      <div class="nav-item" onclick="setFilter('scanner', this)">
        <span class="nav-icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></span><span>X Scanner</span>
      </div>

      <div class="nav-item" onclick="setFilter('yc', this)">
        <span class="nav-icon"><svg viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="3" fill="#FF8A00"/><text x="12" y="15" text-anchor="middle" font-size="10" fill="#FFFFFF" font-family="system-ui, sans-serif" font-weight="bold">Y</text></svg></span><span>YC</span>
      </div>
      <div class="nav-item" onclick="setFilter('ph', this)">
        <span class="nav-icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" fill="#FF6A00"/><path d="M10 8h3.2a2.8 2.8 0 0 1 0 5.6H10V8z" fill="#FFFFFF"/><rect x="10" y="8" width="2" height="8" fill="#FFFFFF"/></svg></span><span>Product Hunt</span>
      </div>
      <div class="nav-item" onclick="showToast('Crunchbase Integration: Coming Soon')">
        <span class="nav-icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M4 4h16v16H4V4zm2 2v12h12V6H6zm2 2h8v2H8V8zm0 4h8v2H8v-2z" /></svg></span><span>Crunchbase</span>
      </div>
      <div class="nav-item" onclick="showToast('LinkedIn Integration: Coming Soon')">
        <span class="nav-icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"/><rect x="2" y="9" width="4" height="13"/><circle cx="4" cy="4" r="2"/></svg></span><span>LinkedIn</span>
      </div>
      <div class="nav-item" onclick="showToast('X / Twitter Integration: Coming Soon')">
        <span class="nav-icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></span><span>Twitter</span>
      </div>
    </div>
  </div>
  <div class="sidebar-footer">
    <div class="status-row">
      <span class="status-dot" id="status-dot"></span><span id="last-updated">Syncing...</span>
    </div>
    <div style="display:flex; gap:12px; margin-top:4px;">
      <a class="footer-link" onclick="openInfo('docs')">Docs</a>
      <a class="footer-link" onclick="openInfo('changelog')">Changelog</a>
    </div>
  </div>
</nav>

<main class="main" id="main-container">
  <header class="command-bar">
    <div class="search-container"><span class="search-icon">⌕</span><input id="search" class="search-input" type="text" placeholder="Search companies or tags..." /></div>
    <div class="view-toggles"><button class="view-btn active" data-view="cards" onclick="setView('cards', this)">Cards</button><button class="view-btn" data-view="table" onclick="setView('table', this)">Table</button></div>
  </header>
  <div class="content-area" id="content-area">
    <div class="feed-header"><div class="feed-title" id="page-title">Today's Picks</div><div class="feed-meta" id="summary-text">Loading...</div></div>
    
    <div id="view-feed"></div>
    <div id="view-scanner"></div>
  </div>
</main>

<div id="toast" class="toast"></div>
<div id="overlay" class="overlay" onclick="closeAll()"></div>
<aside id="panel" class="panel">
  <div class="panel-header"><span class="panel-label">Intelligence Detail</span><button class="panel-close" onclick="closeAll()">×</button></div>
  <div class="panel-content" id="panel-body"></div>
</aside>
<div id="modal" class="modal">
  <div class="modal-header"><span class="modal-title" id="modal-title">Info</span><button class="panel-close" onclick="closeAll()">×</button></div>
  <div class="modal-content" id="modal-body"></div>
</div>

<script>
// CONFIG
const SHEET_ID='1OaIx6CeopLNuiYQrDUurO_6B-cCHh3g2QMWtC7UDz5U';
const GID_MAIN='1778821196';
const GID_X='1426087291'; 
const CACHE_KEY='dos_data';
const CACHE_TIME=5*60*1000;

let STATE={groups:{}, rawData:[], xSignals:[], search:"", source:"today", view:"cards", bookmarks:new Set(), notes:{}};
let autoScrollFrame = null;
let isHovering = false;

/* ICONS */
const globeIcon=`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M2 12h20"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>`;
const starIcon=(f)=>`<svg width="16" height="16" viewBox="0 0 24 24" fill="${f?'currentColor':'none'}" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>`;
const infoIcon=`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>`;
const ycIcon=`<svg width="16" height="16" viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="3" fill="#FF8A00"/><text x="12" y="15" text-anchor="middle" font-size="10" fill="#FFFFFF" font-family="system-ui, sans-serif" font-weight="bold">Y</text></svg>`;
const phIcon=`<svg width="16" height="16" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" fill="#FF6A00"/><path d="M10 8h3.2a2.8 2.8 0 0 1 0 5.6H10V8z" fill="#FFFFFF"/><rect x="10" y="8" width="2" height="8" fill="#FFFFFF"/></svg>`;
const xIcon=`<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>`;

/* UTILS */
function debounce(func,wait){let timeout;return function(...args){clearTimeout(timeout);timeout=setTimeout(()=>func.apply(this,args),wait);};}
function splitCsvLine(line){const out=[];let cur='',q=false;for(let i=0;i<line.length;i++){const ch=line[i];if(ch==='\"'){if(q&&line[i+1]==='\"'){cur+='"';i++;continue;}q=!q;continue;}if(ch===','&&!q){out.push(cur);cur='';continue;}cur+=ch;}out.push(cur);return out.map(s=>s.trim().replace(/^"|"$/g,''));}
function csvToObjects(csv){const lines=csv.split(/\r?\n/).filter(x=>x.trim());if(!lines.length)return[];const h=splitCsvLine(lines[0]);return lines.slice(1).map(l=>{const cols=splitCsvLine(l);const o={};h.forEach((hh,i)=>o[hh]=cols[i]||'');return o;});}

function pick(row, keys) {
  const norm = {}; Object.keys(row).forEach(k => norm[k.toLowerCase().trim()] = row[k]);
  for (const k of keys) { const val = norm[k.toLowerCase().trim()]; if (val && val.trim()) return val.trim(); }
  return "";
}

function favicon(u){try{if(!u)return null; const d=new URL(u.startsWith('http')?u:`https://${u}`).hostname; return `https://www.google.com/s2/favicons?sz=128&domain=${d}`;}catch{return null;}}
function companyLogo(r){const s=pick(r,['source','Source']).toLowerCase(), logo=pick(r,['Logo URL','LogoURL','Logo_Url']), site=pick(r,['Website']); if(s==='ph'&&logo)return logo; return favicon(site);}
function parseDate(r){const d=pick(r,['Extracted Date','ExtractedDate','Date']); const dt=new Date(d); return isNaN(dt)?d:dt.toISOString().slice(0,10);}
function formatDate(d){const dt=new Date(d); return isNaN(dt)?d||'': dt.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'2-digit'});}
function groupByDate(rows){const g={}; rows.forEach(r=>{ const key=parseDate(r)||'Unknown'; (g[key]=g[key]||[]).push(r); }); return g;}
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function showToast(msg){const t=document.getElementById('toast');t.innerHTML=`${infoIcon} ${esc(msg)}`;t.classList.add('visible');setTimeout(()=>t.classList.remove('visible'),3000);}

/* DATA & LOGIC */
function loadLocalData(){
  try{
    const b=localStorage.getItem('dos_bookmarks'); if(b) STATE.bookmarks=new Set(JSON.parse(b));
    const n=localStorage.getItem('dos_notes'); if(n) STATE.notes=JSON.parse(n);
    const cachedData = localStorage.getItem(CACHE_KEY);
    if(cachedData) {
      const {dataMain, dataX} = JSON.parse(cachedData);
      if(dataX) processXData(dataX);
    }
  }catch(e){}
}
function toggleBookmark(e,name){e.stopPropagation(); if(STATE.bookmarks.has(name)) STATE.bookmarks.delete(name); else STATE.bookmarks.add(name); localStorage.setItem('dos_bookmarks', JSON.stringify([...STATE.bookmarks])); render(); // was renderFeed but logic changed
  if(STATE.source !== 'scanner') renderFeed(); 
}
function saveNote(name,val){STATE.notes[name]=val; localStorage.setItem('dos_notes', JSON.stringify(STATE.notes));}

function setFilter(s,el){
  STATE.source=s; 
  document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active')); 
  el.classList.add('active'); 
  
  const t={all:'All Data', today:'Today\'s Picks', saved:'Starred', yc:'YC', ph:'Product Hunt', scanner:'X Scanner'}; 
  document.getElementById('page-title').textContent=t[s]||'Inbox'; 
  
  // TOGGLE DOM LAYERS (THE SPEED FIX)
  const main = document.getElementById('main-container');
  if(s==='scanner') main.classList.add('mode-scanner'); else main.classList.remove('mode-scanner');
  
  // Trigger Auto Scroll only if visible
  if(s==='scanner') {
    // wait for layout
    setTimeout(startAutoScroll, 500);
  } else {
    cancelAnimationFrame(autoScrollFrame);
  }

  // If not scanner, we re-render the Feed to apply filters
  if(s!=='scanner') renderFeed();
}

function setView(v,el){
  STATE.view=v; 
  document.querySelectorAll('.view-btn').forEach(x=>x.classList.remove('active')); 
  el.classList.add('active'); 
  renderFeed();
}

/* AUTO SCROLL ENGINE */
function startAutoScroll(){
  cancelAnimationFrame(autoScrollFrame);
  const el = document.getElementById('content-area');
  // Only scroll if we have enough content to scroll
  if(el.scrollHeight <= el.clientHeight) return;

  function step(){
    if(!isHovering && STATE.source === 'scanner'){
      el.scrollTop += 0.5; // Slow speed
      if(el.scrollTop + el.clientHeight >= el.scrollHeight - 2) {
        el.scrollTop = 0; 
      }
    }
    autoScrollFrame = requestAnimationFrame(step);
  }
  autoScrollFrame = requestAnimationFrame(step);
}

document.getElementById('content-area').addEventListener('mouseenter', () => isHovering = true);
document.getElementById('content-area').addEventListener('mouseleave', () => isHovering = false);


/* RENDERERS */
function renderSkeleton(){
  document.getElementById('view-feed').innerHTML=`<div class="date-group"><div class="skeleton-text" style="width:100px;margin-bottom:12px"></div><div class="skeleton-card"><div class="skeleton-img"></div><div class="skeleton-lines"><div class="skeleton-text" style="width:40%"></div><div class="skeleton-text" style="width:70%"></div></div></div><div class="skeleton-card"><div class="skeleton-img"></div><div class="skeleton-lines"><div class="skeleton-text" style="width:40%"></div><div class="skeleton-text" style="width:70%"></div></div></div></div>`;
}

function getTweetId(url) {
  try {
    const u = new URL(url);
    const parts = u.pathname.split('/');
    const statusIndex = parts.indexOf('status');
    if(statusIndex > -1 && parts[statusIndex+1]) return parts[statusIndex+1];
  } catch(e) {}
  return null;
}

// Render Twitter Layer Once (Hidden)
function renderScannerLayer() {
  const container = document.getElementById('view-scanner');
  if(!STATE.xSignals.length) {
    container.innerHTML = `<div class="empty">No tweets found in your X sheet. Add rows with Source='X'.</div>`;
    return;
  }

  // Clean container just in case
  container.innerHTML = '';
  
  let html = `<div class="scanner-grid">`;
  const idsToRender = [];
  const displayList = [...STATE.xSignals, ...STATE.xSignals]; // Duplicate for loop

  displayList.forEach((r, idx)=>{
    const site = pick(r, ['Website', 'Link', 'URL', 'Tweet', 'Tweet URL', 'Source Link']);
    const tid = getTweetId(site);
    const uniqueId = tid ? `${tid}-${idx}` : null;
    
    if(uniqueId) {
      idsToRender.push(uniqueId);
      html += `
        <div class="tweet-card">
          <div id="skeleton-${uniqueId}" class="tweet-skeleton">
            <div class="skeleton-img" style="width:32px; height:32px; border-radius:50%"></div>
            <div class="skeleton-text" style="width:60%"></div>
            <div class="skeleton-text" style="width:90%; height:60px; margin-top:8px;"></div>
          </div>
          <div id="tweet-${uniqueId}"></div>
        </div>`;
    }
  });
  html += `</div>`;
  container.innerHTML = html;

  // Batch Render
  if(window.twttr && window.twttr.widgets){
     idsToRender.forEach(uid => {
        const realId = uid.split('-')[0];
        // We use a small timeout to batch these somewhat in the JS event loop
        setTimeout(() => {
            twttr.widgets.createTweet(realId, document.getElementById(`tweet-${uid}`), { theme: 'dark', conversation: 'none' })
            .then(()=>{
                const skel = document.getElementById(`skeleton-${uid}`);
                if(skel) skel.remove();
            });
        }, 0);
     });
  }
  
  document.getElementById('summary-text').textContent = `${STATE.xSignals.length} signals`;
}

// Render Startup Feed Layer (Normal)
function renderFeed(){
  const cont = document.getElementById('view-feed');
  const sum = document.getElementById('summary-text');
  
  const g=STATE.groups, q=(STATE.search||"").toLowerCase().trim(), f=STATE.source, vm=STATE.view;
  
  const dates=Object.keys(STATE.groups).sort((a,b)=>b.localeCompare(a));
  
  // Smart Fallback for "Today"
  let targetDate = new Date().toISOString().slice(0,10);
  if(f==='today') {
    // If we have data, default to the latest date available
    if(dates.length > 0) targetDate = dates[0];
    
    // Update Title with Date if it's not actually today
    const realToday = new Date().toISOString().slice(0,10);
    if(targetDate !== realToday) {
       document.getElementById('page-title').textContent = `Latest Picks (${formatDate(targetDate)})`;
    } else {
       document.getElementById('page-title').textContent = `Today's Picks`;
    }
  }

  let total=0; const rows=[];

  dates.forEach(dt=>{
    if(f==='today'&&dt!==targetDate)return;
    STATE.groups[dt].forEach(r=>{
      const n=pick(r,['Correct Name','CorrectName','Name']);
      if(!n||n==='#VALUE!')return;
      const src=pick(r,['source','Source']).toLowerCase();
      
      if(f==='yc'&&src!=='yc')return;
      if(f==='ph'&&src!=='ph')return;
      if(f==='saved'&&!STATE.bookmarks.has(n))return;
      if(src.includes('x')||src.includes('twitter')) return; 

      const tag=pick(r,['Correct Tagline','CorrectTagline','Tagline']);
      if(q && !(n+' '+tag).toLowerCase().includes(q))return;

      total++;
      rows.push({dt, n, tag, src, site:pick(r,['Website']), page:pick(r,['YC URL','YC']), logo:companyLogo(r)});
    });
  });

  sum.textContent=`${total} items`;
  if(!rows.length){cont.innerHTML=`<div class="empty">No companies match this search/filter.</div>`; return;}

  if(vm==='table'){
    let h=`<table class="table-view"><thead><tr><th>Company</th><th>Tagline</th><th>Date</th></tr></thead><tbody>`;
    rows.forEach(x=>{
      h+=`<tr onclick="openPanel('${esc(x.n)}')" style="cursor:pointer"><td><span class="table-company">${esc(x.n)}</span></td><td>${esc(x.tag)}</td><td style="color:var(--text-softer)">${esc(formatDate(x.dt))}</td></tr>`;
    });
    cont.innerHTML=h+`</tbody></table>`;
  } else {
    const grouped={}; rows.forEach(r=>{(grouped[r.dt]=grouped[r.dt]||[]).push(r)});
    let out="";
    Object.keys(grouped).sort((a,b)=>b.localeCompare(a)).forEach(d=>{
      out+=`<section class="date-group"><div class="date-header">${esc(formatDate(d))}</div>`;
      grouped[d].forEach(x=>{
        const isSaved=STATE.bookmarks.has(x.n);
        out+=`
        <article class="card" onclick="openPanel('${esc(x.n)}')">
          <div class="card-left">${x.logo?`<img src="${esc(x.logo)}">`:`<div class="card-left-fallback">${esc(x.n[0])}</div>`}</div>
          <div class="card-center">
            <div class="card-top-row">
              <div class="card-main"><div class="card-name">${esc(x.n)}</div><div class="card-tagline">${esc(x.tag)}</div></div>
              <div class="card-right">
                ${x.src==='yc'?`<div class="yc-pill">YC W26</div>`:''}
                <div class="card-link-row">
                  <button class="btn-link ${isSaved?'btn-link--active':''}" onclick="toggleBookmark(event,'${esc(x.n)}')" title="Save">${starIcon(isSaved)}</button>
                  ${x.site?`<a class="btn-link" href="${esc(x.site)}" target="_blank" onclick="event.stopPropagation()">${globeIcon}</a>`:''}
                </div>
              </div>
            </div>
          </div>
        </article>`;
      });
      out+=`</section>`;
    });
    cont.innerHTML=out;
  }
}

function processXData(csvText){
  const rows = csvToObjects(csvText);
  STATE.xSignals = rows.filter(r=>{
    const s = pick(r,['source','Source']).toLowerCase();
    return (s.includes('x') || s.includes('twitter'));
  });
}

/* FETCHING */
async function load(){
  loadLocalData(); 
  renderSkeleton();

  const lastEl=document.getElementById('last-updated'), dot=document.getElementById('status-dot');
  
  const fetchSheet = async (gid) => {
    return (await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${gid}`)).text();
  };

  try{
    const [csvMain, csvX] = await Promise.all([fetchSheet(GID_MAIN), fetchSheet(GID_X)]);
    
    // Process Main
    const rowsMain = csvToObjects(csvMain);
    STATE.rawData = rowsMain;
    const validMain = rowsMain.filter(r=>pick(r,['Correct Name','CorrectName','Name']));
    STATE.groups = groupByDate(validMain);

    // Process X
    processXData(csvX);

    // RENDER BOTH LAYERS
    renderFeed(); // Main Feed
    renderScannerLayer(); // Hidden Scanner Layer (Pre-load)

    const d=new Date();
    lastEl.textContent=`Synced ${d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}`;
    dot.classList.remove('cached');
  }catch(e){
    console.error(e);
  }
}

/* PANEL/MODAL UTILS */
function openPanel(name){
  const item = STATE.rawData.find(r=>pick(r,['Correct Name','CorrectName','Name'])===name);
  if(!item)return;
  const n=pick(item,['Correct Name','CorrectName','Name']), tag=pick(item,['Correct Tagline','CorrectTagline','Tagline']), site=pick(item,['Website']), logo=companyLogo(item), note=STATE.notes[n]||"";
  const domain=site?new URL(site.startsWith('http')?site:`https://${site}`).hostname:'No Website';
  document.getElementById('panel-body').innerHTML=`
    <div class="panel-hero"><div class="panel-logo">${logo?`<img src="${esc(logo)}">`:`<span>${esc(n[0])}</span>`}</div><div class="panel-title"><h2>${esc(n)}</h2><div class="panel-domain">${esc(domain)}</div></div></div>
    <div class="panel-tagline">${esc(tag)}</div>
    <div class="panel-section"><label class="panel-label">Actions</label><div class="panel-actions">${site?`<a href="${esc(site)}" target="_blank" class="action-btn primary">Visit Website</a>`:''}<button class="action-btn" onclick="navigator.clipboard.writeText('${esc(site)}'); showToast('Link Copied');">Copy Link</button></div></div>
    <div class="panel-section"><label class="panel-label">Private Notes</label><textarea class="panel-notes" placeholder="Notes..." oninput="saveNote('${esc(n)}',this.value)">${esc(note)}</textarea></div>`;
  document.getElementById('panel').classList.add('open'); document.getElementById('overlay').classList.add('open');
}
function openInfo(t){
  const titles={docs:'Documentation',changelog:'Changelog'};
  const content={
    docs:`<h3>Getting Started</h3><p>discovery/os aggregates startups from YC and Product Hunt.</p><h3>Data Sources</h3><p>Data is synced live from our Database every 5 minutes.</p>`,
    changelog:`<h3>v1.6</h3><ul><li>Smart "Latest Date" Fallback</li><li>Improved Mobile Layout</li><li>Instant Skeleton Loading</li></ul>`
  };
  document.getElementById('modal-title').textContent=titles[t]; document.getElementById('modal-body').innerHTML=content[t];
  document.getElementById('modal').classList.add('open'); document.getElementById('overlay').classList.add('open');
}
function closeAll(){document.getElementById('panel').classList.remove('open');document.getElementById('modal').classList.remove('open');document.getElementById('overlay').classList.remove('open');}
document.addEventListener('keydown',e=>{if(e.key==='Escape')closeAll();});

document.getElementById('search').addEventListener('input', debounce(e=>{STATE.search=e.target.value; renderFeed();},300));
load();
</script>
</body>
</html>
